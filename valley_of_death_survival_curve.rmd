# ============================================================================
# VALLEY OF DEATH - DATA-DRIVEN SURVIVAL CURVE FOR RSTUDIO
# ============================================================================
# 
# This script creates a survival curve visualization showing actual startup 
# failure patterns from the dataset - a true representation backed by real data.
# 
# Required packages: tidyverse, ggplot2, scales, patchwork
# ============================================================================

library(tidyverse)
library(ggplot2)
library(scales)
library(patchwork)

# ============================================================================
# CONFIGURATION
# ============================================================================

BACKGROUND_COLOR <- "#1e2738"
GRID_COLOR <- "#3a4555"
TEXT_COLOR <- "#ffffff"
SUBTITLE_COLOR <- "#8899aa"
AXIS_COLOR <- "#a0aec0"

COLORS <- list(
  extreme_danger = "#dc2626",
  high_risk = "#ea580c",
  moderate_risk = "#f97316",
  caution = "#facc15",
  improving = "#84cc16",
  safe_zone = "#22c55e",
  funding_gap = "#dc2626",
  stage_default = "#374151",
  milestone = "#fbbf24",
  curve = "#ffffff"
)

# ============================================================================
# THEME
# ============================================================================

theme_dark_dashboard <- function() {
  theme_minimal(base_size = 14) +
    theme(
      plot.background = element_rect(fill = BACKGROUND_COLOR, color = NA),
      panel.background = element_rect(fill = BACKGROUND_COLOR, color = NA),
      panel.grid.major.y = element_line(color = GRID_COLOR, linewidth = 0.3),
      panel.grid.major.x = element_line(color = GRID_COLOR, linewidth = 0.2, linetype = "dotted"),
      panel.grid.minor = element_blank(),
      text = element_text(color = TEXT_COLOR),
      axis.text = element_text(color = AXIS_COLOR, size = 11),
      axis.title = element_text(color = TEXT_COLOR, face = "bold", size = 13),
      legend.background = element_rect(fill = "transparent", color = NA),
      legend.text = element_text(color = TEXT_COLOR, size = 10),
      plot.margin = margin(15, 20, 15, 20),
      axis.line = element_blank(),
      axis.ticks = element_blank()
    )
}

# ============================================================================
# DATA LOADING
# ============================================================================

cat("Loading data...\n")

# UPDATE THIS PATH to your local file
df <- read_csv("/Users/zahir/Downloads/failures_all.csv", show_col_types = FALSE)

# Extract years
df <- df %>%
  mutate(
    Start_Year = as.numeric(str_extract(`Years.of.Operation`, "\\d{4}")),
    End_Year = as.numeric(str_extract(`Years.of.Operation`, "\\d{4}$")),
    Years_Active = End_Year - Start_Year
  ) %>%
  filter(!is.na(Years_Active), Years_Active >= 0, Years_Active <= 15)

total_startups <- nrow(df)
cat("Total companies analyzed:", total_startups, "\n")

# ============================================================================
# CALCULATE SURVIVAL STATISTICS
# ============================================================================

# Count failures at each year
failure_counts <- df %>%
  count(Years_Active, name = "failures") %>%
  complete(Years_Active = 0:15, fill = list(failures = 0)) %>%
  arrange(Years_Active) %>%
  mutate(
    cumulative_failures = cumsum(failures),
    survivors = total_startups - cumulative_failures,
    survival_rate = survivors / total_startups * 100,
    failure_rate = failures / total_startups * 100
  )

cat("\nSurvival Data:\n")
print(failure_counts)

# ============================================================================
# TITLE PLOT
# ============================================================================

p_title <- ggplot() +
  annotate("text", x = 0.5, y = 0.7, 
           label = "the Valley of Death",
           color = TEXT_COLOR, size = 11, fontface = "bold") +
  annotate("text", x = 0.5, y = 0.25,
           label = paste0("Survival curve based on ", total_startups, " startup failures"),
           color = SUBTITLE_COLOR, size = 4.5) +
  xlim(0, 1) + ylim(0, 1) +
  theme_void() +
  theme(plot.background = element_rect(fill = BACKGROUND_COLOR, color = NA),
        plot.margin = margin(15, 25, 0, 25))

# ============================================================================
# TIMELINE STAGES
# ============================================================================

stages <- data.frame(
  Stage = c("PRE-SEED", "SEED", "FUNDING GAP", "EARLY", "GROWTH"),
  Start = c(0, 1.5, 3, 6, 9),
  End = c(1.5, 3, 6, 9, 15),
  Is_Danger = c(FALSE, FALSE, TRUE, FALSE, FALSE)
)

p_timeline <- ggplot(stages) +
  geom_rect(aes(xmin = Start, xmax = End, ymin = 0.15, ymax = 0.85, fill = Is_Danger),
            color = GRID_COLOR, linewidth = 0.8) +
  geom_text(aes(x = (Start + End) / 2, y = 0.5, label = Stage),
            color = TEXT_COLOR, fontface = "bold", size = 4) +
  scale_fill_manual(values = c("FALSE" = COLORS$stage_default, "TRUE" = COLORS$funding_gap),
                    guide = "none") +
  scale_x_continuous(limits = c(0, 15), expand = c(0.01, 0)) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_void() +
  theme(plot.background = element_rect(fill = BACKGROUND_COLOR, color = NA),
        plot.margin = margin(5, 25, 0, 25))

# ============================================================================
# MAIN SURVIVAL CURVE
# ============================================================================

# Create zone color assignment
failure_counts <- failure_counts %>%
  mutate(
    zone_color = case_when(
      survival_rate >= 80 ~ COLORS$safe_zone,
      survival_rate >= 60 ~ COLORS$improving,
      survival_rate >= 40 ~ COLORS$caution,
      survival_rate >= 25 ~ COLORS$moderate_risk,
      survival_rate >= 10 ~ COLORS$high_risk,
      TRUE ~ COLORS$extreme_danger
    )
  )

# Key milestones
milestones <- failure_counts %>%
  filter(Years_Active %in% c(3, 5, 7))

p_main <- ggplot(failure_counts, aes(x = Years_Active, y = survival_rate)) +
  
  # Background risk zone bands
  annotate("rect", xmin = 0, xmax = 15, ymin = 0, ymax = 10, 
           fill = COLORS$extreme_danger, alpha = 0.2) +
  annotate("rect", xmin = 0, xmax = 15, ymin = 10, ymax = 25, 
           fill = COLORS$high_risk, alpha = 0.15) +
  annotate("rect", xmin = 0, xmax = 15, ymin = 25, ymax = 40, 
           fill = COLORS$moderate_risk, alpha = 0.12) +
  annotate("rect", xmin = 0, xmax = 15, ymin = 40, ymax = 60, 
           fill = COLORS$caution, alpha = 0.10) +
  annotate("rect", xmin = 0, xmax = 15, ymin = 60, ymax = 80, 
           fill = COLORS$improving, alpha = 0.10) +
  annotate("rect", xmin = 0, xmax = 15, ymin = 80, ymax = 105, 
           fill = COLORS$safe_zone, alpha = 0.12) +
  
  # 50% survival line
  geom_hline(yintercept = 50, color = "#64748b", linewidth = 0.8, linetype = "dashed") +
  annotate("text", x = 14, y = 53, label = "50% Survival", 
           color = "#64748b", size = 3.5, fontface = "italic", hjust = 1) +
  
  # Fill under curve using geom_ribbon
  geom_ribbon(aes(ymin = 0, ymax = survival_rate, fill = zone_color), alpha = 0.5) +
  scale_fill_identity() +
  
  # Step survival curve with glow
  geom_step(color = COLORS$curve, linewidth = 4, alpha = 0.2) +
  geom_step(color = COLORS$curve, linewidth = 2) +
  
  # Data points
  geom_point(color = COLORS$curve, size = 3, stroke = 1.5) +
  
  # Milestone annotations

  geom_segment(data = milestones, 
               aes(x = Years_Active, xend = Years_Active, y = 0, yend = survival_rate),
               color = COLORS$milestone, linetype = "dotted", linewidth = 0.7, alpha = 0.7) +
  geom_segment(data = milestones,
               aes(x = 0, xend = Years_Active, y = survival_rate, yend = survival_rate),
               color = COLORS$milestone, linetype = "dotted", linewidth = 0.7, alpha = 0.7) +
  geom_label(data = milestones,
             aes(x = Years_Active + 0.5, y = survival_rate + 4, 
                 label = paste0(round(survival_rate), "%")),
             fill = BACKGROUND_COLOR, color = COLORS$milestone, 
             fontface = "bold", size = 4, label.size = 0) +
  
  # Valley of Death annotation
  annotate("label", x = 8, y = 35, 
           label = "Valley of Death\n(Peak Risk Zone)",
           fill = BACKGROUND_COLOR, color = COLORS$extreme_danger,
           fontface = "bold", size = 4.5, label.size = 1) +
  annotate("curve", x = 7, y = 38, xend = 5.2, yend = 58,
           curvature = 0.3, arrow = arrow(length = unit(0.2, "cm"), type = "closed"),
           color = COLORS$extreme_danger, linewidth = 1) +
  
  # Scales
  scale_x_continuous(breaks = 0:15, limits = c(0, 15), expand = c(0.02, 0)) +
  scale_y_continuous(breaks = seq(0, 100, 20), limits = c(0, 105)) +
  labs(x = "Years Since Founding", y = "Survival Rate (%)") +
  theme_dark_dashboard()

# ============================================================================
# FAILURE DISTRIBUTION BAR CHART
# ============================================================================

failure_counts <- failure_counts %>%
  mutate(
    bar_color = case_when(
      failure_rate >= 10 ~ COLORS$extreme_danger,
      failure_rate >= 5 ~ COLORS$high_risk,
      failure_rate >= 3 ~ COLORS$moderate_risk,
      TRUE ~ COLORS$caution
    )
  )

p_bars <- ggplot(failure_counts, aes(x = Years_Active, y = failure_rate)) +
  geom_col(aes(fill = bar_color), width = 0.8, alpha = 0.85) +
  scale_fill_identity() +
  geom_text(aes(label = ifelse(failures > 0, failures, "")), 
            vjust = -0.5, color = TEXT_COLOR, fontface = "bold", size = 3) +
  
  # Peak annotation
  annotate("text", 
           x = failure_counts$Years_Active[which.max(failure_counts$failure_rate)] + 2,
           y = max(failure_counts$failure_rate) + 1,
           label = paste0("Peak: Year ", failure_counts$Years_Active[which.max(failure_counts$failure_rate)]),
           color = COLORS$extreme_danger, fontface = "bold", size = 4) +
  annotate("segment",
           x = failure_counts$Years_Active[which.max(failure_counts$failure_rate)] + 1.5,
           xend = failure_counts$Years_Active[which.max(failure_counts$failure_rate)] + 0.3,
           y = max(failure_counts$failure_rate) + 0.5,
           yend = max(failure_counts$failure_rate) + 0.2,
           arrow = arrow(length = unit(0.15, "cm"), type = "closed"),
           color = COLORS$extreme_danger, linewidth = 1) +
  
  scale_x_continuous(breaks = 0:15, limits = c(-0.5, 15.5)) +
  scale_y_continuous(limits = c(0, max(failure_counts$failure_rate) * 1.3)) +
  labs(x = "Years Since Founding", y = "Failure Rate (%)",
       title = "Annual Failure Distribution (number of companies failing each year)") +
  theme_dark_dashboard() +
  theme(plot.title = element_text(color = SUBTITLE_COLOR, size = 11, hjust = 0.5))

# ============================================================================
# LEGEND
# ============================================================================

legend_data <- data.frame(
  x = 1:6,
  label = c("<10%\nCritical", "10-25%\nDanger", "25-40%\nAt Risk",
            "40-60%\nCaution", "60-80%\nStable", ">80%\nSafe"),
  color = c(COLORS$extreme_danger, COLORS$high_risk, COLORS$moderate_risk,
            COLORS$caution, COLORS$improving, COLORS$safe_zone)
)

p_legend <- ggplot(legend_data) +
  geom_tile(aes(x = x, y = 0.5, fill = color), width = 0.9, height = 0.6) +
  geom_text(aes(x = x, y = 0.5, label = label), 
            color = TEXT_COLOR, fontface = "bold", size = 3, lineheight = 0.85) +
  scale_fill_identity() +
  annotate("text", x = 3.5, y = 1, label = "SURVIVAL ZONES",
           color = SUBTITLE_COLOR, fontface = "bold", size = 3.5) +
  scale_x_continuous(limits = c(0.4, 6.6)) +
  scale_y_continuous(limits = c(0, 1.2)) +
  theme_void() +
  theme(plot.background = element_rect(fill = BACKGROUND_COLOR, color = NA),
        plot.margin = margin(5, 60, 15, 60))

# ============================================================================
# COMBINE PLOTS
# ============================================================================

final_plot <- p_title / p_timeline / p_main / p_bars / p_legend +
  plot_layout(heights = c(0.08, 0.06, 0.45, 0.3, 0.11))

# ============================================================================
# SAVE
# ============================================================================

ggsave("/Users/zahir/Downloads/valley_of_death_survival_curve.png", final_plot,
       width = 16, height = 14, dpi = 300, bg = BACKGROUND_COLOR)

cat("\n‚úì Visualization saved!\n")

# ============================================================================
# PRINT KEY STATISTICS
# ============================================================================

cat("\n", paste(rep("=", 60), collapse = ""), "\n")
cat("KEY INSIGHTS FROM SURVIVAL ANALYSIS\n")
cat(paste(rep("=", 60), collapse = ""), "\n")

cat("\nüìâ Survival Milestones:\n")
for(yr in c(1, 2, 3, 5, 7, 10)) {
  surv <- failure_counts %>% filter(Years_Active == yr) %>% pull(survival_rate)
  if(length(surv) > 0) {
    cat("   After", yr, "year(s):", round(surv, 1), "% still operating\n")
  }
}

fifty_pct_year <- failure_counts %>% filter(survival_rate <= 50) %>% 
  slice_min(Years_Active) %>% pull(Years_Active)
cat("\n‚ö†Ô∏è  50% of startups fail by Year", fifty_pct_year, "\n")

cat("\nüî• Highest Risk Years:\n")
top_years <- failure_counts %>% arrange(desc(failures)) %>% head(5)
for(i in 1:nrow(top_years)) {
  cat("   Year", top_years$Years_Active[i], ":", 
      top_years$failures[i], "failures (", round(top_years$failure_rate[i], 1), "%)\n")
}

valley_failures <- failure_counts %>% 
  filter(Years_Active >= 3 & Years_Active <= 7) %>%
  summarise(total = sum(failures)) %>% pull(total)
cat("\nüéØ Valley of Death (Years 3-7):", valley_failures, "failures (",
    round(valley_failures/total_startups*100, 1), "% of all)\n")

cat(paste(rep("=", 60), collapse = ""), "\n")

